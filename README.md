# KZCinema

## Описание проекта

Это веб-приложение для работы с фильмами, построенное на стеке MERN (MongoDB, Express, React, Node.js). Приложение использует архитектуру с балансировкой нагрузки через Nginx.

## Технологический стек

### Frontend:
- React 19
- React Router 7
- React Bootstrap
- Axios
- Animate.css
- React Toastify

### Backend:
- Node.js
- Express
- MongoDB
- Mongoose
- JWT аутентификация
- Multer для загрузки файлов
- NodeCache

### DevOps:
- Docker и Docker Compose
- Nginx (балансировщик нагрузки)
- Многоконтейнерная архитектура

## Структура проекта

```
project/
│
├── react-express-movie/    # Frontend приложение на React
│   ├── src/                # Исходный код
│   ├── public/             # Статические файлы
│   └── Dockerfile          # Конфигурация Docker для фронтенда
│
├── server-express/         # Backend сервер на Express
│   ├── index.js            # Основной файл сервера
│   ├── models/             # MongoDB модели
│   ├── utils/              # Вспомогательные функции
│   ├── config/             # Конфигурационные файлы
│   └── Dockerfile          # Конфигурация Docker для бэкенда
│
├── nginx/                  # Настройки Nginx
│   └── nginx.conf          # Конфигурация балансировщика нагрузки
│
└── docker-compose.yml      # Конфигурация Docker Compose
```

## Запуск проекта

### Предварительные требования

- Docker и Docker Compose
- Node.js (для локальной разработки)
- npm или yarn (для локальной разработки)

### Запуск через Docker Compose (рекомендуется)

1. Клонируйте репозиторий:
   ```bash
   git clone https://github.com/KabylBeken/KZCinema.git
   cd KZCinema
   ```

2. Запустите все сервисы с помощью Docker Compose:
   ```bash
   docker-compose up -d
   ```

3. После успешного запуска приложение будет доступно по следующим адресам:
   - Frontend: http://localhost:3000
   - Backend API: http://localhost:5050
   - MongoDB: localhost:27017

### Запуск локально (для разработки)

#### Backend:

1. Перейдите в директорию сервера:
   ```bash
   cd server-express
   ```

2. Установите зависимости:
   ```bash
   npm install
   ```

3. Запустите MongoDB (должен быть установлен локально или через Docker):
   ```bash
   # Через Docker
   docker run -d -p 27017:27017 --name mongodb mongo:latest
   ```

4. Запустите сервер в режиме разработки:
   ```bash
   npm run dev
   ```
   
   Сервер будет запущен на http://localhost:5001

#### Frontend:

1. Перейдите в директорию фронтенда:
   ```bash
   cd react-express-movie
   ```

2. Установите зависимости:
   ```bash
   npm install
   ```

3. Запустите React приложение:
   ```bash
   npm start
   ```
   
   Приложение будет запущено на http://localhost:3000

## Масштабирование

Архитектура приложения поддерживает горизонтальное масштабирование бэкенда. Чтобы добавить больше бэкенд-серверов, отредактируйте docker-compose.yml и добавьте новые сервисы по аналогии с backend1 и backend2. Nginx автоматически начнет балансировать нагрузку на все бэкенд-серверы.

## Особенности реализации

### 1. Динамический импорт в React
В проекте используется ленивая загрузка компонентов с помощью React.lazy и Suspense. Это позволяет загружать компоненты только тогда, когда они необходимы, что улучшает производительность приложения и сокращает время первой загрузки.

```javascript
// Пример из App.js
const UsersList = React.lazy(() => import('./UsersList'));
// ...

// Пример использования Suspense
<Suspense fallback={<LoadingFallback />}>
  <UsersList />
</Suspense>
```

### 2. Оптимизация с useMemo
В компоненте MoviesList используется хук useMemo для оптимизации фильтрации и сортировки списка фильмов. Это предотвращает ненужные вычисления при каждом перерендеринге компонента.

```javascript
// Пример из MoviesList.js
const filteredAndSortedMovies = useMemo(() => {
  // Логика фильтрации и сортировки...
}, [movies, searchQuery, sortField, sortOrder]);
```

### 3. Кэширование на сервере
Express-сервер использует node-cache для кэширования часто запрашиваемых данных:
- GET-запросы кэшируются на определенное время
- Кэш автоматически сбрасывается при изменении данных
- Поддерживается возможность мониторинга и управления кэшем

## Порты
- Frontend: 3000 (хост) → 3001 (контейнер)
- Backend API через балансировщик: 5050 (хост) → 80 (контейнер nginx)
- Backend-серверы: не экспортируются напрямую, доступны через балансировщик
- MongoDB: 27017 (хост) → 27017 (контейнер)

## Важные примечания
- При изменении файлов в проекте необходимо перестроить образы Docker
- Все данные MongoDB сохраняются в именованном томе и сохраняются между перезапусками контейнеров
- Для запуска в production-окружении необходимо изменить настройки безопасности 

## Балансировка нагрузки

В проекте настроен балансировщик нагрузки для распределения запросов между несколькими экземплярами бэкенда.

### Архитектура балансировки

- **Load Balancer (NGINX)**: Распределяет запросы между бэкенд-серверами
- **Бэкенд-сервер 1 и 2**: Идентичные контейнеры, обрабатывающие API-запросы
- **MongoDB**: Общая база данных для всех бэкенд-серверов

### Проверка работы балансировки

Балансировка нагрузки работает автоматически и не требует тестирования через пользовательский интерфейс.
Запросы к API на порт 5050 автоматически распределяются между бэкенд-серверами по принципу Round-Robin.

### Важные замечания

- API доступен по адресу http://localhost:5050
- Во frontend-приложении уже настроено обращение к правильному API-адресу
- Все запросы с фронтенда к бэкенду проходят через балансировщик нагрузки

### Просмотр логов балансировки

Для просмотра логов бэкенд-серверов и отслеживания распределения запросов выполните команды:

```bash
# Логи первого бэкенд-сервера
docker logs backend1

# Логи второго бэкенд-сервера
docker logs backend2

# Логи балансировщика нагрузки
docker logs load-balancer
```

## Администрирование кэша на сервере

Сервер предоставляет специальные API-маршруты для администрирования кэша:

### Статистика кэша
```
GET /cache-stats?secret=admin123
```

### Ручная очистка кэша
```
POST /clear-cache?secret=admin123
```
С опциональным параметром в теле запроса `{pattern: '/movies'}` для очистки определенных маршрутов.
